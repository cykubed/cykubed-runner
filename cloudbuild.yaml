timeout: 900s
steps:
  - name: 'gcr.io/cloud-builders/git'
    script: |
      git config -f .gitmodules submodule.src/common.url https://source.developers.google.com/p/cykubeapp/r/github_cykube_cykube-common
      git submodule init
      git submodule update

  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'pull',  'europe-docker.pkg.dev/cykubeapp/cykubed/runner-base:latest']

  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'pull',  'europe-docker.pkg.dev/cykubeapp/cykubed/runner-node16.x:latest']

  - name: alpine/httpie
    id: Get next version number
    entrypoint: sh
    args:
      - '-ce'
      - |-
        http GET https://api.cykubed.com/admin/image/runner/next-version/minor -A bearer -a $$CYKUBE_API_TOKEN -b > /workspace/version.txt && echo "Building version $(cat /workspace/version.txt)"
    secretEnv: ['CYKUBE_API_TOKEN']

  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: [ './scripts/cloudbuild/build-docker.sh']

  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: [ './scripts/cloudbuild/push-docker.sh']

  - name: alpine/httpie
    id: Update Cykube app with latest runner images and notify Slack
    entrypoint: sh
    args:
      - '-ce'
      - |-
       http POST https://api.cykubed.com/admin/runner/image -A bearer -a $$CYKUBE_API_TOKEN  < /workspace/cykube-payload.json &&
       http POST https://hooks.slack.com/services/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 < /workspace/slack-payload.json &&
       http POST "https://api.cykubed.com/admin/image/runner/current-version/$(cat /workspace/version.txt)" -A bearer -a $$CYKUBE_API_TOKEN
    secretEnv: ['CYKUBE_API_TOKEN']

availableSecrets:
  secretManager:
    - versionName: projects/489847359241/secrets/cykube-api-token/versions/8
      env: 'CYKUBE_API_TOKEN'
